---
# title: "`r params$area_name`"
title: ""
author: ""
date: ""
# date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  area_num: 5
  area_name: "Temp Name"
geometry: margin=1.5cm
output:
  pdf_document
linkcolor: blue
# header-includes:
#   - \usepackage{caption}
#   - \captionsetup[figure]{labelformat=empty}
# editor_options: 
#   chunk_output_type: console
# knit: (function(inputFile, encoding){ 
#     out_dir <- '/';
#     rmarkdown::render(inputFile, encoding = encoding, output_file=file.path(dirname(inputFile), out_dir, 'ECOL592_RDAandCCA_GWoolsey.pdf')) 
#   })
---

```{r, include=F, warning=F, message=F, echo=F}
# knit options
knitr::opts_chunk$set(
  echo = FALSE
  , warning = FALSE
  , message = FALSE
  , include = TRUE
  , eval = TRUE
  , fig.asp = 0.8
  , fig.width = 7
  # , fig.height = 8
  , fig.align = 'center'
)
remove(list = ls()[grep("_temp",ls())])
gc()
```

```{r call-fns}
##################################################
##################################################
# set the figure size
##################################################
##################################################
bb_temp <- wf_landscapes %>% 
  dplyr::filter(area_name==area_nm_list[params$area_num]) %>% 
  sf::st_transform(3857) %>% 
  sf::st_bbox()
w_temp <- bb_temp[3] - bb_temp[1]
h_temp <- bb_temp[4] - bb_temp[2]
# fig.asp sets the height-to-width ratio
image_asp_temp <- min(h_temp/w_temp,1)
# fix for layered constraints text sizing
base_size_temp = ifelse(image_asp_temp==1,8,9)
ggtext_size_temp = ifelse(image_asp_temp==1,7,10)
image_asp_facet_temp <- max(image_asp_temp*ifelse(image_asp_temp==1,0.65,0.55),0.35)
# width_for_image <- round(((21.59-2*2)/2.54),1) # max width of 21.59cm page with 2cm margin (converted to in)
# height_for_image_temp <- round((width_for_image * h_temp) / w_temp, 1)

##################################################
##################################################
# call all the functions
##################################################
##################################################
# set aggregate factor for raster data
  agg_fact_temp <- 20
# !!!!!!!!!THIS IS SET GLOBALLY!!!!!!!!!
  # plt_basemap <<- landscape_basemap_fn(row_n = params$area_num, my_base_size = base_size_temp)
# load raster data
# !!!!!!!!!THIS IS SET GLOBALLY!!!!!!!!!
  rast_list_temp <<- raster_data_read_fn(row_n = params$area_num)
  # rast_list_temp <- raster_data_read_fn(row_n = params$area_num)

#################
# PLOTS
#################
title_plot_temp <- title_plot_fn(row_n = params$area_num)

# fireshed project area plots
plt_fshed_cnstrnt_lvl_temp <- plt_fshed_cnstrnt_lvl_fn(row_n = params$area_num)
plt_patch_prop_temp <- plt_patch_prop_fn(row_n = params$area_num)
plt_obj_trtbl_temp <- plt_obj_trtbl_fn(row_n = params$area_num)

# names and labels
area_name_nost <- wf_landscapes %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(area_name == area_nm_list[params$area_num]) %>% 
  dplyr::pull(name)
area_st <- wf_landscapes %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(area_name == area_nm_list[params$area_num]) %>% 
  dplyr::pull(state)
area_acres <- wf_landscapes %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(area_name == area_nm_list[params$area_num]) %>% 
  dplyr::pull(acres) %>% 
  scales::comma(suffix = "k", scale = 1e-3, accuracy = 1)
area_ha <- wf_landscapes %>% 
  sf::st_drop_geometry() %>% 
  dplyr::filter(area_name == area_nm_list[params$area_num]) %>% 
  dplyr::pull(hectares) %>% 
  scales::comma(suffix = "k", scale = 1e-3, accuracy = 1)
```

```{r fshed-cnstrnt-dist, fig.asp=0.36, fig.width=7}
# ```{r fshed-cnstrnt-dist, fig.height=3, fig.width=11}
plt_cnstrnt_class_table +
plt_fshed_cnstrnt_lvl_temp +
  theme(
    legend.position = "bottom"
    , legend.margin = margin(-0.3,0.0,0.0,0.0, "cm")
    , plot.title = element_blank()
    , plot.margin = margin(0.0,0.0,0.0,0.2, "cm")
    , axis.title.x = element_text(size=6)
  ) +
  patchwork::plot_layout(nrow = 1, widths = c(1,1.45)) 
```

Levels of mechanical constraint used to classify fireshed project areas were chosen based on USFS Wildfire Crisis Strategy objectives and science showing that fuels treatments are more effective as the percentage of the landscape treated progressively increases. We then calculated the proportion of fireshed project areas in each of these mechanical constraint classes both within the overall landscape area and within high-risk firesheds only.

```{r largest-patch-map, fig.asp=image_asp_facet_temp}
# ```{r largest-patch-map, fig.asp=image_asp_facet_temp}
patchwork::plot_spacer() +
  plt_patch_prop_temp +
  patchwork::plot_layout(ncol = 1, heights = c(1,0.2)) &
  theme(
    legend.position = "none"
    , plot.title = element_blank()
    , plot.margin = margin(0,0,0,0, "cm")
  )
```

We selected the largest patch of interconnected fireshed project areas by constraint class and calculated the percent of the area of the overall landscape comprised by this patch (i.e., largest patch index).Comparison is made between the largest patch of project areas classified as high constraint (100–81% constrained; 0–19% available for mechanical treatment) and the largest patch of project areas classified as low constraint (0–59% constrained; 41–100% available). Extensive patches with little mechanical constraint represent opportunities for land managers to design plans that incorporate the principles of effective landscape-scale fuel treatments.

```{r obj_trtbl, fig.asp=0.3, fig.width=7}
plt_obj_trtbl_temp +
  theme(
    plot.title = element_blank()
    , plot.margin = margin(0.0,0.0,0.0,0.0, "cm")
    , axis.text.y = element_text(size=9)
  )
```

sdafasdgfafdg asdf asdgterhg sad sdafasdgfafdg asdf asdgterhg sad sdafasdgfafdg asdf asdgterhg sad sdafasdgfafdg asdf asdgterhg sad sdafasdgfafdg asdf asdgterhg sad sdafasdgfafdg asdf asdgterhg sad sdafasdgfafdg asdf asdgterhg sad 
